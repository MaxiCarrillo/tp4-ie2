<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Transformaci√≥n de Ana - Historieta Interactiva V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Nueva paleta: azules claros y cer√∫leos estilo c√≥mic */
            --color-bg: #E9F4FF;            /* Azul muy claro de fondo */
            --color-primary: #176B9E;      /* Azul cer√∫leo medio */
            --color-secondary: #4BB5FF;    /* Azul claro vibrante */
            --color-accent: #FFB347;       /* Naranja suave para acentos */
            --color-text: #102035;         /* Azul gris√°ceo oscuro para texto */
            --color-border: #051428;       /* Borde casi negro azulado */
            --color-panel-bg: #F7FBFF;     /* Panel casi blanco azulado */

            /* Fuentes estilo c√≥mic */
            --font-title: 'Bangers', cursive;
            --font-narrative: 'Open Sans', Arial, sans-serif;
            --font-comic: 'Comic Sans MS', 'Comic Neue', 'Chalkboard SE', cursive;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-narrative);
            font-size: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            /* Trama tipo papel c√≥mic */
            background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.05) 1px, transparent 0);
            background-size: 18px 18px;
        }

        /* --- UI GENERAL --- */
        h1 {
            font-family: var(--font-title);
            color: #FFFFFF;
            font-size: 3.4rem;
            text-shadow: 5px 5px 0 #102035;
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            border: 4px solid var(--color-border);
            border-radius: 14px;
            padding: 12px 26px;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 2px;
            line-height: 1;
        }

        .comic-container {
            width: 100%;
            max-width: 900px;
            background: #FFFFFF;
            border: 5px solid var(--color-border);
            box-shadow: 12px 12px 0 #102035,
                        18px 18px 0 var(--color-secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 30px;
        }

        /* --- VI√ëETAS (SCENES) --- */
        .scene {
            display: none;
            padding: 22px 26px 28px;
            animation: fadeIn 0.45s ease-out;
            min-height: 560px;
            flex-direction: column;
            justify-content: space-between;
            background:
                linear-gradient(135deg, rgba(23,107,158,0.05), transparent 50%),
                radial-gradient(circle at top left, rgba(75,181,255,0.12), transparent 60%);
        }

        .scene.active { display: flex; }

        .visual-stage {
            flex-grow: 1;
            background: var(--color-panel-bg);
            border: 3px solid var(--color-border);
            margin-bottom: 20px;
            position: relative;
            display: flex;
            flex-direction: column; /* para dejar espacio claro debajo de la imagen */
            justify-content: flex-start;
            align-items: stretch;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.06);
        }

        /* Imagen + zona clicable ampliada */
        .visual-stage-inner {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            background-color: #dfefff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--font-comic);
            color: #4c6a8a;
            font-size: 1.1rem;
            text-align: center;
            border: 2px dashed rgba(16,32,53,0.4);
        }

        .image-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Franja clicable claramente visible debajo de la imagen */
        .click-hint-area {
            background: rgba(23,107,158,0.08);
            border-top: 2px dashed rgba(16,32,53,0.3);
            padding: 10px 14px;
            text-align: center;
            font-family: var(--font-comic);
            font-size: 0.95rem;
            color: var(--color-text);
            cursor: pointer;
        }

        .click-hint-area span.icon {
            margin-right: 6px;
        }

        .click-hint-area:hover {
            background: rgba(75,181,255,0.2);
        }

        .interaction-target {
            cursor: pointer;
            transition: transform 0.18s ease-out, filter 0.18s ease-out;
        }
        .interaction-target:hover {
            filter: brightness(1.08);
            transform: translateY(-2px);
        }

        /* Globos de Di√°logo */
        .speech-bubble {
            background: #FFFFFF;
            border: 3px solid var(--color-border);
            border-radius: 18px;
            padding: 16px 18px;
            font-family: var(--font-comic);
            position: relative;
            margin-top: 16px;
            box-shadow: 4px 4px 0 #102035;
            opacity: 0;
            transform: translateY(18px);
            transition: opacity 0.45s ease-out, transform 0.45s ease-out;
        }

        .speech-bubble.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: -14px;
            left: 32px;
            border-width: 0 14px 14px;
            border-style: solid;
            border-color: transparent transparent var(--color-border);
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            top: -11px;
            left: 32px;
            border-width: 0 14px 14px;
            border-style: solid;
            border-color: transparent transparent #FFFFFF;
            z-index: 1;
        }

        .narrative-box {
            background: var(--color-primary);
            color: #FFFFFF;
            padding: 10px 16px;
            font-size: 1rem;
            border: 3px solid var(--color-border);
            margin-bottom: 14px;
            font-weight: 700;
            text-align: center;
            border-radius: 8px;
            box-shadow: 3px 3px 0 #102035;
        }

        /* --- CONTROLES --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: linear-gradient(90deg, var(--color-secondary), #a7dbff);
            border-top: 5px solid var(--color-border);
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        button {
            background: #FFFFFF;
            border: 3px solid var(--color-border);
            padding: 10px 22px;
            font-family: var(--font-comic);
            font-weight: bold;
            cursor: pointer;
            border-radius: 999px;
            box-shadow: 4px 4px 0 #102035;
            transition: transform 0.12s ease-out, background-color 0.2s ease-out, box-shadow 0.12s ease-out;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button.primary {
            background-color: var(--color-accent);
            color: #102035;
        }

        button.secondary {
            background-color: var(--color-primary);
            color: #FFFFFF;
        }

        button:hover:not(:disabled) {
            background-color: #f7fbff;
        }

        button.primary:hover:not(:disabled) {
            background-color: #ffd08a;
        }

        button.secondary:hover:not(:disabled) {
            background-color: #1d7fbe;
        }

        button:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #102035;
        }

        button:disabled {
            background: #dde4ef;
            color: #9aa4b5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* --- LOG & PROGRESS --- */
        .log-panel {
            margin-top: 20px;
            width: 100%;
            max-width: 900px;
        }

        .log-toggle {
            background: var(--color-primary);
            color: #ffffff;
            width: 100%;
            text-align: left;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal {
            background: #050b14;
            color: #7CFFB2;
            font-family: 'Courier New', monospace;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            display: none;
            border: 3px solid var(--color-border);
            font-size: 0.85rem;
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
            position: relative;
        }

        .terminal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #ff5f57, #febc2e, #28c840);
        }

        .terminal.open { display: block; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 3px; }
        .log-time { color: #ffff00; margin-right: 10px; }

        /* --- Minijuego Drag & Drop --- */
        .minigame-container {
            display: flex;
            flex-direction: column;
            gap: 18px;
            width: 100%;
            padding: 18px 18px 20px;
            border: 2px dashed var(--color-primary);
            border-radius: 10px;
            background-color: #f2f8ff;
            margin-top: 16px;
        }

        .drop-zones {
            display: flex;
            justify-content: space-around;
            gap: 14px;
            min-height: 200px;
        }

        .drop-zone {
            flex: 1;
            border: 3px dashed var(--color-secondary);
            border-radius: 10px;
            padding: 14px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-height: 180px;
        }

        .drop-zone.hover {
            background-color: #e0f6ff;
            border-color: var(--color-primary);
        }
        .drop-zone.correct {
            border-color: #3bb273;
            box-shadow: 0 0 10px rgba(59,178,115,0.8);
        }

        .drop-zone h3 {
            font-family: var(--font-comic);
            color: var(--color-primary);
            margin-bottom: 8px;
            font-size: 1.05rem;
            text-align: center;
        }

        .draggable-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .draggable {
            background-color: var(--color-secondary);
            color: #051428;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: grab;
            font-family: var(--font-narrative);
            font-size: 0.9rem;
            box-shadow: 2px 2px 0 #102035;
            transition: background-color 0.2s, transform 0.1s;
        }

        .draggable:hover {
            background-color: #7fd0ff;
        }
        .draggable:active {
            cursor: grabbing;
            transform: scale(0.97);
        }
        .draggable.dragged {
            opacity: 0.6;
        }
        .draggable.correct {
            background-color: #3bb273;
            color: #ffffff;
            cursor: default;
        }

        .minigame-status {
            text-align: center;
            font-family: var(--font-comic);
            font-size: 1.02rem;
            color: var(--color-text);
        }
        .minigame-status.success { color: #3bb273; }

        /* --- Animaciones generales --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            h1 { font-size: 2.4rem; margin-bottom: 18px; }
            .comic-container { margin: 10px; box-shadow: 6px 6px 0 #102035; }
            .scene { min-height: 520px; padding: 16px; }
            .speech-bubble { padding: 14px 16px; font-size: 0.9rem; }
            .controls { padding: 10px 14px; flex-direction: column; }
            button { padding: 8px 16px; font-size: 0.85rem; width: 100%; }
            #page-indicator { text-align: center; }
            .drop-zones { flex-direction: column; }
        }

    </style>
</head>
<body>

<audio id="pageFlipSound" src="page-flip.mp3" preload="auto"></audio>
<audio id="correctSound" src="correct.mp3" preload="auto"></audio>
<audio id="incorrectSound" src="incorrect.mp3" preload="auto"></audio>
<h1>La Transformaci√≥n de Ana</h1>

<div class="comic-container">

    <div class="scene active" id="scene-1" data-index="1">
        <div class="narrative-box">ESCENA 1: LA FRUSTRACI√ìN (Inicio de la Aventura)</div>
        <div class="visual-stage">
            <div class="image-placeholder interaction-target" onclick="interact(1)">
                <img src="scene-1.jpg" alt="Escena 1: La Frustraci√≥n" style="display: block;">
            </div>
        </div>
        <!-- Gu√≠a para el usuario en la primera diapositiva -->
        <div class="speech-bubble visible" id="help-bubble" style="margin-top: 10px; font-size: 0.9rem; background: #f2f8ff; position: relative;">
            <button type="button" onclick="dismissHelp()" style="position:absolute; top:6px; right:10px; border:none; background:transparent; font-weight:bold; cursor:pointer; font-family:var(--font-comic);">‚úï</button>
            <strong>Gu√≠a r√°pida:</strong><br>
            ‚Ä¢ Toca la ilustraci√≥n de la vi√±eta para revelar el di√°logo y desbloquear el bot√≥n "Siguiente".<br>
            ‚Ä¢ Usa los botones <em>Anterior</em> y <em>Siguiente</em> de abajo para pasar de escena.<br>
            ‚Ä¢ En las escenas de minijuego, arrastra cada tarjeta a la categor√≠a o respuesta que creas correcta para ganar puntos.
        </div>
        <div class="speech-bubble" id="bubble-1">
            <strong>Ana (Pensamiento):</strong> "¬°Ugh! Otro curso donde solo 'consumo' PDFs. Siento que solo cumplo tr√°mites, ¬°no que realmente aprendo o creo algo!"
        </div>
    </div>

    <div class="scene" id="scene-2" data-index="2">
        <div class="narrative-box">ESCENA 2: EL DESPERTAR (La Voz Interior)</div>
        <div class="visual-stage">
            <div class="image-placeholder interaction-target" onclick="interact(2)">
                <img src="scene-2.jpg" alt="Escena 2: El Despertar" style="display: block;">
            </div>
        </div>
        <div class="speech-bubble" id="bubble-2">
            <strong>Ana:</strong> "¬°Incre√≠ble! Nunca me hab√≠a escuchado explicar estos conceptos con mis propias palabras. Al grabarme, ¬°la informaci√≥n cobra vida y la entiendo mucho mejor!"
        </div>
    </div>

    <div class="scene" id="scene-3" data-index="3">
        <div class="narrative-box">ESCENA 3: DISE√ëANDO EL PROBLEMA (Contexto Real)</div>
        <div class="visual-stage">
            <div class="image-placeholder interaction-target" onclick="interact(3)">
                <img src="scene-3.jpg" alt="Escena 3: Dise√±ando el Problema" style="display: block;">
            </div>
        </div>
        <div class="speech-bubble" id="bubble-3">
            <strong>Narrador:</strong> Ana decide que su aprendizaje debe impactar. Propone un proyecto para abordar la contaminaci√≥n del arroyo local, ¬°un problema real de su comunidad!
        </div>
    </div>

    <div class="scene" id="scene-4" data-index="4">
        <div class="narrative-box">ESCENA 4: EL DI√ÅLOGO SOCR√ÅTICO (Chatbot Coach)</div>
        <div class="visual-stage">
            <div class="image-placeholder interaction-target" onclick="interact(4)">
                <img src="scene-4.jpg" alt="Escena 4: El Di√°logo Socr√°tico" style="display: block;">
            </div>
        </div>
        <div class="speech-bubble" id="bubble-4">
            <strong>Chatbot S√≥crates:</strong> "¬øPor qu√© propones una estrategia de recolecci√≥n de datos sin acceso a internet?"<br>
            <strong>Ana:</strong> "No todos mis vecinos tienen fibra √≥ptica, pero todos tienen historias que contar y conocimientos valiosos. ¬°Usaremos entrevistas y mapas colaborativos f√≠sicos!"
        </div>
    </div>

    <div class="scene" id="scene-5" data-index="5">
        <div class="narrative-box">ESCENA 5: EVALUACI√ìN DE PARES (Colaboraci√≥n Activa)</div>
        <div class="visual-stage">
            <div class="image-placeholder interaction-target" onclick="interact(5)">
                <img src="scene-5.jpg" alt="Escena 5: Evaluaci√≥n de Pares" style="display: block;">
            </div>
        </div>
        <div class="speech-bubble" id="bubble-5">
            <strong>Narrador:</strong> El aula de Ana se transforma en un laboratorio de ideas. Los compa√±eros co-eval√∫an las propuestas usando r√∫bricas que dise√±aron ellos mismos, ¬°aprendiendo de y con sus pares!
        </div>
    </div>

    <div class="scene" id="scene-6" data-index="6">
        <div class="narrative-box">ESCENA 6: ¬°MINIJUEGO! CONCEPTOS DE LA PRAXIS</div>
        <div class="visual-stage">
            <div class="image-placeholder">
                <img src="scene-6.jpg" alt="Escena 6: Minijuego - Conceptos de la Praxis" style="display: block;">
            </div>
            <div class="minigame-container interaction-target" onclick="interact(6)">
                <p class="minigame-status" id="minigame-status">Arrastra los conceptos a la categor√≠a correcta:</p>
                <div class="drop-zones">
                    <div class="drop-zone" id="zone-tradicional" data-category="tradicional">
                        <h3>Pedagog√≠a Tradicional</h3>
                    </div>
                    <div class="drop-zone" id="zone-activa" data-category="activa">
                        <h3>Pedagog√≠a Activa / Praxis</h3>
                    </div>
                </div>
                <div class="draggable-items" id="draggable-items">
                    <div class="draggable" draggable="true" data-concept="Consumo de Informaci√≥n" data-category="tradicional">Consumo de Informaci√≥n</div>
                    <div class="draggable" draggable="true" data-concept="Memorizaci√≥n" data-category="tradicional">Memorizaci√≥n</div>
                    <div class="draggable" draggable="true" data-concept="Creaci√≥n de Conocimiento" data-category="activa">Creaci√≥n de Conocimiento</div>
                    <div class="draggable" draggable="true" data-concept="Resoluci√≥n de Problemas Reales" data-category="activa">Resoluci√≥n de Problemas Reales</div>
                    <div class="draggable" draggable="true" data-concept="Docente Transmisor" data-category="tradicional">Docente Transmisor</div>
                    <div class="draggable" draggable="true" data-concept="Docente Gu√≠a/Facilitador" data-category="activa">Docente Gu√≠a/Facilitador</div>
                    <div class="draggable" draggable="true" data-concept="Evaluaci√≥n Sumativa" data-category="tradicional">Evaluaci√≥n Sumativa</div>
                    <div class="draggable" draggable="true" data-concept="Co-evaluaci√≥n y Formativa" data-category="activa">Co-evaluaci√≥n y Formativa</div>
                </div>
                <button id="minigame-check-btn" onclick="checkMinigame()" disabled>Verificar</button>
            </div>
        </div>
        <div class="speech-bubble" id="bubble-6">
            <strong>Ana (Pensamiento):</strong> "¬°El cambio es radical! De una pedagog√≠a de consumo pasivo a una de creaci√≥n activa y significativo. Este minijuego lo resume bien."
        </div>
    </div>

    <!-- NUEVA ESCENA 7: MINIJUEGO 2 (VERDADERO/FALSO) -->
    <div class="scene" id="scene-7" data-index="7">
        <div class="narrative-box">ESCENA 7: MINIJUEGO - ¬øPRAXIS O TRADICIONAL?</div>
        <div class="visual-stage">
            <div class="image-placeholder">
                <img src="scene-7.jpg" alt="Escena 7: Minijuego - Praxis o Tradicional" style="display: block;">
            </div>
            <div class="minigame-container interaction-target" onclick="interact(7)">
                <p class="minigame-status" id="minigame-status-2">Lee cada afirmaci√≥n y marca si refleja una pedagog√≠a centrada en la praxis.</p>
                <div id="vf-questions">
                    <div class="vf-item" data-correct="true">
                        <span>El estudiante investiga problemas reales de su contexto.</span>
                        <button type="button" onclick="answerVF(this, true, 2)">S√≠, es praxis</button>
                        <button type="button" onclick="answerVF(this, false, 2)">No, es tradicional</button>
                    </div>
                    <div class="vf-item" data-correct="false">
                        <span>La evaluaci√≥n se basa solo en un examen final de memoria.</span>
                        <button type="button" onclick="answerVF(this, true, 2)">S√≠, es praxis</button>
                        <button type="button" onclick="answerVF(this, false, 2)">No, es tradicional</button>
                    </div>
                    <div class="vf-item" data-correct="true">
                        <span>El estudiante dialoga con sus pares y con la comunidad para tomar decisiones.</span>
                        <button type="button" onclick="answerVF(this, true, 2)">S√≠, es praxis</button>
                        <button type="button" onclick="answerVF(this, false, 2)">No, es tradicional</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="speech-bubble" id="bubble-7">
            <strong>Ana (Docente):</strong> "Cada decisi√≥n que tomamos en el aula puede acercarnos a la praxis o mantenernos en la tradici√≥n. ¬øReconoces la diferencia?"
        </div>
    </div>

    <!-- NUEVA ESCENA 8: MINIJUEGO 3 (ORDENAR PASOS) -->
    <div class="scene" id="scene-8" data-index="8">
        <div class="narrative-box">ESCENA 8: MINIJUEGO - PASOS DE UNA EXPERIENCIA DE PRAXIS</div>
        <div class="visual-stage">
            <div class="image-placeholder">
                <img src="scene-8.jpg" alt="Escena 8: Minijuego - Pasos de la Praxis" style="display: block;">
            </div>
            <div class="minigame-container interaction-target" onclick="interact(8)">
                <p class="minigame-status" id="minigame-status-3">Ordena los pasos de una secuencia did√°ctica basada en la praxis.</p>
                <ol id="steps-list">
                    <li data-order="2">Dise√±ar actividades de indagaci√≥n y acci√≥n en el territorio.</li>
                    <li data-order="1">Identificar un problema significativo en la realidad del estudiante.</li>
                    <li data-order="4">Compartir los resultados con la comunidad y reflexionar sobre el impacto.</li>
                    <li data-order="3">Analizar los datos recogidos junto con los estudiantes.</li>
                </ol>
                <button type="button" onclick="shuffleSteps()">Mezclar pasos</button>
                <button type="button" onclick="checkSteps()">Verificar orden</button>
            </div>
        </div>
        <div class="speech-bubble" id="bubble-8">
            <strong>Ana:</strong> "Una buena experiencia de praxis es un viaje: problema, acci√≥n, reflexi√≥n y transformaci√≥n. ¬øEn qu√© orden lo har√≠as t√∫?"
        </div>
    </div>

    <!-- ESCENA 9: CIERRE, MEDALLAS Y MENSAJE FINAL -->
    <div class="scene" id="scene-9" data-index="9">
        <div class="narrative-box">ESCENA 9: RESULTADOS Y REFLEXI√ìN FINAL</div>
        <div class="visual-stage" id="results-stage">
            <div class="image-placeholder">
                <span style="font-family: var(--font-comic);">Haz clic en "Verificar resultados" para ver tu medalla</span>
            </div>
            <div style="width:100%; text-align:center; margin-top:14px;">
                <button id="results-btn" class="primary" onclick="revealResults()">Verificar resultados</button>
            </div>
            <div id="medals-container" style="width:100%; text-align:center; margin-top:20px;"></div>
        </div>
        <div class="speech-bubble" id="bubble-9">
            <strong>Ana:</strong> "Este recorrido solo es el comienzo. Usa lo que aprendiste para transformar tus futuras clases."<br><br>
            <button onclick="generateReport()" class="primary" style="width: 100%; border-color: var(--color-border);">üìÇ Generar Informe de Pr√°ctica</button>
        </div>
    </div>

    <!-- ESCENA 10: DESCARGA AUTOM√ÅTICA DEL INFORME -->
    <div class="scene" id="scene-10" data-index="10">
        <div class="narrative-box">ESCENA 10: DESCARGA DEL INFORME</div>
        <div class="visual-stage">
            <div class="image-placeholder">
                <span style="font-family: var(--font-comic);">Generando y descargando tu informe...</span>
            </div>
        </div>
        <div class="speech-bubble" id="bubble-10">
            <strong>Sistema:</strong> Tu informe se est√° descargando autom√°ticamente. ¬°Gracias por recorrer la historieta!
        </div>
    </div>

    <div class="controls">
        <button id="btn-prev" class="secondary" onclick="changeScene(-1)" disabled>‚¨Ö Anterior</button>
        <span id="page-indicator" style="font-weight: bold; align-self: center; font-family: var(--font-comic); font-size: 1.1rem; color: var(--color-text);">1 / 10</span>
        <button id="btn-next" class="primary" onclick="changeScene(1)" disabled>Siguiente ‚û°</button>
    </div>
</div>

<div class="log-panel">
    <button class="log-toggle secondary" onclick="toggleTerminal()">üìã Ver Diario de Campo (Historial)</button>
    <div class="terminal" id="terminal-content">
        <div class="log-entry">> Sistema iniciado. Esperando interacci√≥n del usuario...</div>
    </div>
</div>

<div style="max-width: 900px; margin-top: 40px; border-top: 3px dashed var(--color-secondary); padding-top: 20px; color: #666; font-size: 0.9rem; text-align: center;">
    <h3>PARA EL DOCENTE: Gu√≠a Pedag√≥gica y de Implementaci√≥n</h3>
    <p><strong>Objetivo Pedag√≥gico:</strong> Esta historieta interactiva busca que el futuro docente reflexione y experimente un cambio de paradigma, movi√©ndose de una ense√±anza basada en la transmisi√≥n de contenidos a una pedagog√≠a de la praxis, donde el estudiante es constructor activo de su aprendizaje, resolviendo problemas reales y colaborando.</p>
    <p><strong>Verificaci√≥n de Integridad y Progreso:</strong> Al finalizar la historieta, el sistema genera un archivo TXT con un historial de las interacciones del usuario y un hash SHA-256 √∫nico. Este hash sirve como "firma digital" para asegurar que el contenido del informe no ha sido alterado manualmente, confirmando que el estudiante ha navegado por la experiencia. Si el estudiante intenta modificar el texto del informe, el hash resultante no coincidir√° con el calculado por el sistema.</p>
</div>

<script>
    // --- ESTADO DEL LABORATORIO ---
    let currentScene = 1;
    const totalScenes = 10; // actualizado por nueva escena
    const state = {
        unlocked: Array(totalScenes + 1).fill(false),
        interactions: [],
        startTime: new Date(),
        sceneTimes: {}
    };
    state.sceneTimes[1] = new Date();

    const pageFlipSound = document.getElementById('pageFlipSound');
    const correctSound = document.getElementById('correctSound');
    const incorrectSound = document.getElementById('incorrectSound');

    // Sistema de puntos global
    let score = 0;
    const maxScore = 29; // 10 (minijuego 1) + 9 (minijuego 2) + 10 (minijuego 3)

    function addPoints(points) {
        score += points;
        logToTerminal(`PUNTOS: Has ganado ${points} puntos. Total actual: ${score}.`);
    }

    // --- L√ìGICA DE NAVEGACI√ìN ---
    function updateScene() {
        document.querySelectorAll('.scene').forEach(el => el.classList.remove('active'));
        const activeScene = document.getElementById(`scene-${currentScene}`);
        if (activeScene) activeScene.classList.add('active');

        if (pageFlipSound) {
            pageFlipSound.currentTime = 0;
            pageFlipSound.play().catch(() => {});
        }

        const indicator = document.getElementById('page-indicator');
        if (indicator) indicator.innerText = `${currentScene} / ${totalScenes}`;
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        if (btnPrev) btnPrev.disabled = (currentScene === 1);

        const isUnlocked = state.unlocked[currentScene];
        if (btnNext) btnNext.disabled = (currentScene === totalScenes || !isUnlocked);

        if (!state.sceneTimes[currentScene]) {
            state.sceneTimes[currentScene] = new Date();
        }

        logToTerminal(`Navegaci√≥n: Usuario entr√≥ a Escena ${currentScene}`);

        // Si es la escena final (10), generar y descargar autom√°ticamente
        if (currentScene === totalScenes) {
            setTimeout(() => {
                try { generateReport(); } catch (e) {}
            }, 350);
        }
    }

    function revealResults() {
        const btn = document.getElementById('results-btn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Mostrando...';
        }
        showMedals();
        // Desbloquear la escena 9 para permitir pasar a la 10
        if (!state.unlocked[9]) {
            completeInteraction(9);
        }
    }

    function changeScene(direction) {
        const next = currentScene + direction;
        if (next < 1 || next > totalScenes) return;
        currentScene = next;
        updateScene();
    }

    // --- L√ìGICA DE INTERACCI√ìN ---
    function interact(sceneIndex) {
        // CASO ESPECIAL: Escena 6 (Minijuego drag & drop)
        if (sceneIndex === 6) {
            if (!state.unlocked[sceneIndex]) {
                logToTerminal(`JUEGO: Usuario interactuando con el tablero de clasificaci√≥n.`);
            }
            return;
        }
        // Escena 7 y 8: los minijuegos 2 y 3 se completan desde sus funciones espec√≠ficas
        if (sceneIndex === 7 || sceneIndex === 8) {
            if (!state.unlocked[sceneIndex]) {
                logToTerminal(`JUEGO: Usuario explorando el minijuego de la escena ${sceneIndex}.`);
            }
            return;
        }

        if (state.unlocked[sceneIndex]) return; // Ya completado

        completeInteraction(sceneIndex);
    }

    function completeInteraction(sceneIndex) {
        state.unlocked[sceneIndex] = true;

        // Mostrar di√°logo/burbuja
        const bubble = document.getElementById(`bubble-${sceneIndex}`);
        if (bubble) bubble.classList.add('visible');

        // Habilitar bot√≥n siguiente si no estamos en la √∫ltima escena
        if (sceneIndex < totalScenes) {
            const btnNext = document.getElementById('btn-next');
            if (btnNext) btnNext.disabled = false;
        }

        const interactionData = {
            scene: sceneIndex,
            timestamp: new Date().toISOString(),
            action: "INTERACCI√ìN_COMPLETADA"
        };
        state.interactions.push(interactionData);

        let msg = `Escena ${sceneIndex} completada.`;
        if (sceneIndex === 6) msg = "MINIJUEGO SUPERADO: Conceptos clasificados correctamente.";

        logToTerminal(`ACCI√ìN: ${msg} [Desbloqueado]`);

        if (sceneIndex !== 6 && correctSound) {
            correctSound.currentTime = 0;
            correctSound.play().catch(() => {});
        }
    }

    // Cerrar la vi√±eta de ayuda inicial
    function dismissHelp() {
        const help = document.getElementById('help-bubble');
        if (help) help.style.display = 'none';
    }

    // --- Minijuego 2 y 3, sistema de medallas y resto de funciones permanecen igual ---
    // --- L√ìGICA DEL MINIJUEGO (DRAG & DROP) ---
    const draggables = document.querySelectorAll('.draggable');
    const dropZones = document.querySelectorAll('.drop-zone');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => {
            draggable.classList.add('dragged');
        });

        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragged');
        });
    });

    dropZones.forEach(zone => {
        zone.addEventListener('dragover', e => {
            e.preventDefault(); // Necesario para permitir soltar
            zone.classList.add('hover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('hover');
        });

        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('hover');
            const draggable = document.querySelector('.dragged');
            if (draggable) {
                zone.appendChild(draggable);
                checkMinigameStatus(); // Verificar si ya se puede validar
            }
        });
    });

    function checkMinigameStatus() {
        // Habilitar bot√≥n "Verificar" solo si no quedan items en el origen
        const originalContainer = document.getElementById('draggable-items');
        const remaining = originalContainer.querySelectorAll('.draggable').length;

        const checkBtn = document.getElementById('minigame-check-btn');
        if (remaining === 0) {
            checkBtn.disabled = false;
            checkBtn.style.backgroundColor = 'var(--color-accent)';
            checkBtn.style.color = 'white';
            checkBtn.style.cursor = 'pointer';
        }
    }

    function checkMinigame() {
        let correctCount = 0;
        const totalItems = 8; // 10 puntos por cada minijuego bien resuelto
        let allCorrect = true;

        const zones = document.querySelectorAll('.drop-zone');
        zones.forEach(zone => {
            const zoneCategory = zone.getAttribute('data-category');
            const items = zone.querySelectorAll('.draggable');

            items.forEach(item => {
                if (item.getAttribute('data-category') === zoneCategory) {
                    correctCount++;
                    item.classList.add('correct'); // Estilo visual verde
                    item.draggable = false; // Bloquear los correctos
                } else {
                    allCorrect = false;
                    // Opcional: devolver visualmente el item incorrecto
                    // item.style.backgroundColor = '#ffcccc';
                }
            });
        });

        const statusMsg = document.getElementById('minigame-status');

        if (allCorrect && correctCount === totalItems) {
            statusMsg.innerText = "¬°EXCELENTE! Has clasificado correctamente los paradigmas.";
            statusMsg.classList.add('success');
            if (correctSound) correctSound.play();

            // Deshabilitar controles del juego
            document.getElementById('minigame-check-btn').disabled = true;
            document.getElementById('minigame-check-btn').innerText = "¬°COMPLETADO!";

            // DESBLOQUEAR ESCENA 6
            completeInteraction(6);
            addPoints(10);

        } else {
            statusMsg.innerText = "A√∫n hay errores. Revisa los conceptos rojos o mal ubicados e intenta de nuevo.";
            statusMsg.style.color = "red";
            if (incorrectSound) incorrectSound.play();

            setTimeout(() => { statusMsg.style.color = "var(--color-text)"; }, 3000);
        }
    }

    // Minijuego 2: verdadero/falso estilo praxis/tradicional
    function answerVF(button, userSaysPraxis, gameId) {
        const item = button.parentElement;
        if (!item || item.classList.contains('answered')) return;

        const isPraxisCorrect = item.getAttribute('data-correct') === 'true';
        const isCorrect = (userSaysPraxis === isPraxisCorrect);

        item.classList.add('answered');
        Array.from(item.querySelectorAll('button')).forEach(btn => btn.disabled = true);

        if (isCorrect) {
            item.style.backgroundColor = '#e5ffe9';
            addPoints(3);
        } else {
            item.style.backgroundColor = '#ffe5e5';
        }

        // Si todas las vf-item de este juego han sido respondidas, marcar escena como completa
        const container = document.getElementById('vf-questions');
        const remaining = container.querySelectorAll('.vf-item:not(.answered)').length;
        if (remaining === 0 && !state.unlocked[7]) {
            completeInteraction(7);
        }
    }

    // Minijuego 3: ordenar pasos
    function shuffleSteps() {
        const list = document.getElementById('steps-list');
        const items = Array.from(list.children);
        items.sort(() => Math.random() - 0.5);
        items.forEach(li => list.appendChild(li));
    }

    function checkSteps() {
        const list = document.getElementById('steps-list');
        const items = Array.from(list.children);
        let allCorrect = true;
        items.forEach((li, index) => {
            const required = parseInt(li.getAttribute('data-order'), 10);
            if (required === index + 1) {
                li.style.backgroundColor = '#e5ffe9';
            } else {
                li.style.backgroundColor = '#ffe5e5';
                allCorrect = false;
            }
        });

        if (allCorrect && !state.unlocked[8]) {
            addPoints(10);
            completeInteraction(8);
        }
    }

    // Mostrar medallas al llegar a la √∫ltima escena
    function showMedals() {
        const container = document.getElementById('medals-container');
        if (!container) return;
        container.innerHTML = '';

        const title = document.createElement('h2');
        title.style.fontFamily = 'var(--font-title)';
        title.style.marginBottom = '10px';

        const msg = document.createElement('p');
        msg.style.fontFamily = 'var(--font-comic)';

        let medalType = 'none';
        if (score >= 24) medalType = 'gold';
        else if (score >= 18) medalType = 'silver';
        else if (score >= 10) medalType = 'bronze';

        if (medalType === 'none') {
            title.textContent = 'Recomendaci√≥n';
            msg.textContent = 'Creemos que ser√≠a mejor que vuelvas a ver la historieta y revises los conceptos para obtener un mejor resultado.';
            container.appendChild(title);
            container.appendChild(msg);
            return;
        }

        title.textContent = '¬°Resultados de tu recorrido!';
        const medalWrap = document.createElement('div');
        medalWrap.style.display = 'flex';
        medalWrap.style.justifyContent = 'center';
        medalWrap.style.alignItems = 'center';
        medalWrap.style.gap = '12px';
        medalWrap.style.margin = '16px 0';

        const medal = document.createElement('div');
        medal.style.width = '90px';
        medal.style.height = '90px';
        medal.style.borderRadius = '50%';
        medal.style.border = '4px solid var(--color-border)';
        medal.style.display = 'flex';
        medal.style.alignItems = 'center';
        medal.style.justifyContent = 'center';
        medal.style.fontFamily = 'var(--font-title)';
        medal.style.fontSize = '2rem';
        medal.style.color = '#fff';
        medal.style.animation = 'fadeIn 0.5s ease-out, pulseMedal 1.2s ease-in-out infinite alternate';

        if (medalType === 'gold') {
            medal.textContent = 'ü•á';
            medal.style.background = '#f0c419';
        } else if (medalType === 'silver') {
            medal.textContent = 'ü•à';
            medal.style.background = '#c0c0c0';
        } else {
            medal.textContent = 'ü•â';
            medal.style.background = '#cd7f32';
        }

        // peque√±as estrellitas animadas alrededor
        const stars = document.createElement('div');
        stars.style.position = 'relative';
        stars.style.width = '0';
        stars.style.height = '0';
        const star = (x, y, delay) => {
            const s = document.createElement('div');
            s.textContent = '‚ú¶';
            s.style.position = 'absolute';
            s.style.left = x + 'px';
            s.style.top = y + 'px';
            s.style.color = '#fff';
            s.style.textShadow = '0 0 6px rgba(255,255,255,0.8)';
            s.style.animation = `fadeIn 0.4s ease ${delay}s both`;
            return s;
        };
        stars.appendChild(star(-60, -40, 0.0));
        stars.appendChild(star(60, -30, 0.15));
        stars.appendChild(star(-50, 40, 0.3));
        stars.appendChild(star(55, 50, 0.45));

        medalWrap.appendChild(medal);
        medalWrap.appendChild(stars);

        msg.textContent = `Puntos obtenidos: ${score} de un m√°ximo de ${maxScore}.`;

        container.appendChild(title);
        container.appendChild(medalWrap);
        container.appendChild(msg);
    }

    // Animaci√≥n de medalla
    const style = document.createElement('style');
    style.textContent = `@keyframes pulseMedal { 0% { transform: translateY(0) scale(1); } 100% { transform: translateY(-4px) scale(1.06); } }`;
    document.head.appendChild(style);

    // --- SISTEMA DE LOGS (TERMINAL) ---
    function logToTerminal(text) {
        const terminal = document.getElementById('terminal-content');
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">[${time}]</span> ${text}`;
        terminal.appendChild(entry);
        terminal.scrollTop = terminal.scrollHeight;
    }

    function toggleTerminal() {
        document.getElementById('terminal-content').classList.toggle('open');
    }

    // --- GENERACI√ìN DE INFORME ---
    async function generateReport() {
        const endTime = new Date();
        const duration = Math.round((endTime - state.startTime) / 1000);

        let reportContent = `BIT√ÅCORA DE TRANSFORMACI√ìN EDUCATIVA\n`;
        reportContent += `=====================================\n`;
        reportContent += `Fecha: ${new Date().toLocaleString()}\n`;
        reportContent += `Duraci√≥n Total: ${duration} segundos\n`;
        reportContent += `Usuario: Estudiante de Formaci√≥n Docente\n\n`;

        reportContent += `REGISTRO DE INTERACCIONES:\n`;
        state.interactions.forEach(inte => {
            reportContent += `[‚úî] Escena ${inte.scene}: ${inte.action} - ${inte.timestamp}\n`;
        });

        reportContent += `\nREFLEXI√ìN FINAL:\n`;
        reportContent += `El estudiante ha completado el recorrido narrativo y ha demostrado diferenciar entre paradigmas tradicionales y activos mediante la clasificaci√≥n de conceptos.\n`;

        // Hashing para integridad
        const hash = await sha256(reportContent);
        reportContent += `\n-------------------------------------\n`;
        reportContent += `FIRMA DIGITAL (HASH SHA-256): ${hash}\n`;
        reportContent += `(Si este archivo es modificado, la firma no coincidir√°)\n`;
        reportContent += `-------------------------------------\n`;

        downloadFile("Bitacora_Transformacion_Ana.txt", reportContent);
    }

    // Funci√≥n Helper para Criptograf√≠a
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function downloadFile(filename, content) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);

        logToTerminal("SISTEMA: Informe generado y descargado correctamente.");
        alert("¬°Felicidades! Tu bit√°cora se ha descargado. S√∫bela a la plataforma Moodle.");
    }
</script>
</body>
</html>
